---

- name: Adding ssh directory
  file: >
    path=~{{ item.username }}/.ssh
    owner={{ item.username }}
    group={{ item.group if item.group is defined else (users_group if users_group else item.username) }}
    state=directory
    mode=0700
  with_items: users
  tags:
    - system
    - users
    - config

- name: Adding ssh keys
  template: >
    src=home-user-ssh-private-key.j2
    dest=~{{ item.username }}/.ssh/id_rsa
    owner={{ item.username }}
    group={{ item.group if item.group is defined else (users_group if users_group else item.username) }}
    mode=0600
  with_items: users
  tags:
    - system
    - users
    - config

- name: Adding authorized keys
  authorized_key: >
    user={{ item.0.username }}
    key="{{ item.1 }}"
  with_subelements:
    - users
    - authorized_keys
  tags:
    - system
    - users
    - config
